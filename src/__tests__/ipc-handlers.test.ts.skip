import { ipcMain } from 'electron';
import { DatabaseManager } from '../database';
import { ServerManager } from '../server-manager';

// Mock Electron modules
jest.mock('electron', () => ({
  ipcMain: {
    handle: jest.fn(),
    on: jest.fn()
  },
  app: {
    on: jest.fn(),
    quit: jest.fn()
  },
  BrowserWindow: jest.fn(),
  Menu: {
    buildFromTemplate: jest.fn(),
    setApplicationMenu: jest.fn()
  },
  Tray: jest.fn(),
  nativeImage: {
    createEmpty: jest.fn()
  },
  dialog: {
    showMessageBoxSync: jest.fn()
  }
}));

describe('IPC Handlers - Enhanced Tests', () => {
  let db: DatabaseManager;
  let serverManager: ServerManager;

  beforeEach(async () => {
    db = new DatabaseManager(':memory:');
    await db.init();
    serverManager = new ServerManager(db);
  });

  afterEach(async () => {
    await serverManager.stopAllListeners();
  });

  describe('User Management IPC', () => {
    test('should handle get-all-users', async () => {
      db.createUser({ username: 'user1', password: 'pass1', passwordEnabled: true, guiEnabled: false });
      db.createUser({ username: 'user2', password: 'pass2', passwordEnabled: true, guiEnabled: false });

      const users = db.getAllUsers();
      expect(users.length).toBeGreaterThanOrEqual(2);
    });

    test('should handle create-user', () => {
      const username = 'newuser';
      const password = 'newpass';
      
      const userId = db.createUser({ username, password, passwordEnabled: true, guiEnabled: false });
      
      expect(userId).toBeGreaterThan(0);
      
      const user = db.getUser(username);
      expect(user).toBeDefined();
      expect(user?.username).toBe(username);
    });

    test('should handle update-user', () => {
      db.createUser({ username: 'testuser', password: 'pass', passwordEnabled: true, guiEnabled: false });
      const user = db.getUser('testuser');
      
      if (user) {
        db.updateUser(username, { guiEnabled: true });
        
        const updated = db.getUser('testuser');
        expect(updated?.guiEnabled).toBe(true);
      }
    });

    test('should handle delete-user', () => {
      db.createUser({ username: 'deleteuser', password: 'pass', passwordEnabled: true, guiEnabled: false });
      
      db.deleteUser('deleteuser');
      
      const user = db.getUser('deleteuser');
      expect(user).toBeNull();
    });

    test('should handle get-user', () => {
      db.createUser({ username: 'getuser', password: 'pass', passwordEnabled: true, guiEnabled: false });
      
      const user = db.getUser('getuser');
      
      expect(user).toBeDefined();
      expect(user?.username).toBe('getuser');
    });
  });

  describe('Listener Management IPC', () => {
    test('should handle get-all-listeners', () => {
      db.createListener({
        name: 'SFTP',
        protocol: 'SFTP',
        bindingIp: '0.0.0.0',
        port: 2222,
        enabled: true
      });

      const listeners = db.getAllListeners();
      expect(listeners.length).toBeGreaterThanOrEqual(1);
    });

    test('should handle create-listener', () => {
      const listenerId = db.createListener({
        name: 'New Listener',
        protocol: 'FTP',
        bindingIp: '127.0.0.1',
        port: 2121,
        enabled: true
      });

      expect(listenerId).toBeGreaterThan(0);
      
      const listener = db.getListener(listenerId);
      expect(listener).toBeDefined();
      expect(listener?.name).toBe('New Listener');
    });

    test('should handle update-listener', () => {
      const listenerId = db.createListener({
        name: 'Update Test',
        protocol: 'SFTP',
        bindingIp: '0.0.0.0',
        port: 2222,
        enabled: true
      });

      const listener = db.getListener(listenerId);
      if (listener) {
        if (listener.id) { db.updateListener(listener.id, { enabled: false }); } 
        
        const updated = db.getListener(listenerId);
        expect(updated?.enabled).toBe(false);
      }
    });

    test('should handle delete-listener', () => {
      const listenerId = db.createListener({
        name: 'Delete Test',
        protocol: 'SFTP',
        bindingIp: '0.0.0.0',
        port: 2222,
        enabled: true
      });

      db.deleteListener(listenerId);
      
      const listener = db.getListener(listenerId);
      expect(listener).toBeUndefined();
    });

    test('should handle start-listener', async () => {
      const listenerId = db.createListener({
        name: 'Start Test',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      await expect(serverManager.startListener(listenerId)).resolves.not.toThrow();
    });

    test('should handle stop-listener', async () => {
      const listenerId = db.createListener({
        name: 'Stop Test',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      await serverManager.startListener(listenerId).catch(() => {});
      await expect(serverManager.stopListener(listenerId)).resolves.not.toThrow();
    });

    test('should handle restart-listener', async () => {
      const listenerId = db.createListener({
        name: 'Restart Test',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      await expect(serverManager.restartListener(listenerId)).resolves.not.toThrow();
    });

    test('should handle get-listener-status', () => {
      const listenerId = db.createListener({
        name: 'Status Test',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      const isRunning = serverManager.isListenerRunning(listenerId);
      expect(typeof isRunning).toBe('boolean');
    });
  });

  describe('Virtual Path Management IPC', () => {
    test('should handle get-virtual-paths', () => {
      db.createUser({ username: 'vpuser', password: 'pass', passwordEnabled: true, guiEnabled: false });
      const user = db.getUser('vpuser');

      if (user) {
        db.addVirtualPath({
          userId: user.id!,
          virtualPath: '/home',
          localPath: 'C:\\Home',
          canRead: true,
          canWrite: true,
          canAppend: true,
          canDelete: false,
          canList: true,
          canCreateDir: false,
          canRename: false,
          applyToSubdirs: true
        });

        const vpaths = if (user.id) db.getVirtualPaths(user.id);
        expect(vpaths).toHaveLength(1);
      }
    });

    test('should handle add-virtual-path', () => {
      db.createUser({ username: 'vpuser', password: 'pass', passwordEnabled: true, guiEnabled: false });
      const user = db.getUser('vpuser');

      if (user) {
        const vpathId = db.addVirtualPath({
          userId: user.id!,
          virtualPath: '/data',
          localPath: 'C:\\Data',
          canRead: true,
          canWrite: true,
          canAppend: true,
          canDelete: false,
          canList: true,
          canCreateDir: false,
          canRename: false,
          applyToSubdirs: true
        });

        expect(vpathId).toBeGreaterThan(0);
      }
    });

    test('should handle update-virtual-path', () => {
      db.createUser({ username: 'vpuser', password: 'pass', passwordEnabled: true, guiEnabled: false });
      const user = db.getUser('vpuser');

      if (user) {
        const vpathId = db.addVirtualPath({
          userId: user.id!,
          virtualPath: '/update',
          localPath: 'C:\\Update',
          canRead: true,
          canWrite: false,
          canAppend: false,
          canDelete: false,
          canList: true,
          canCreateDir: false,
          canRename: false,
          applyToSubdirs: true
        });

        const vpaths = if (user.id) db.getVirtualPaths(user.id);
        const vpath = vpaths[0];

        db.updateVirtualPath({
          ...vpath,
          canWrite: true
        });

        const updated = if (user.id) db.getVirtualPaths(user.id)[0];
        expect(updated.canWrite).toBe(true);
      }
    });

    test('should handle delete-virtual-path', () => {
      db.createUser({ username: 'vpuser', password: 'pass', passwordEnabled: true, guiEnabled: false });
      const user = db.getUser('vpuser');

      if (user) {
        const vpathId = db.addVirtualPath({
          userId: user.id!,
          virtualPath: '/delete',
          localPath: 'C:\\Delete',
          canRead: true,
          canWrite: true,
          canAppend: true,
          canDelete: false,
          canList: true,
          canCreateDir: false,
          canRename: false,
          applyToSubdirs: true
        });

        db.deleteVirtualPath(vpathId);

        const vpaths = if (user.id) db.getVirtualPaths(user.id);
        expect(vpaths).toHaveLength(0);
      }
    });
  });

  describe('Permission Management IPC', () => {
    test('should handle get-permissions', () => {
      db.createUser({ username: 'permuser', password: 'pass', passwordEnabled: true, guiEnabled: false });
      const user = db.getUser('permuser');

      const listenerId = db.createListener({
        name: 'Perm Test',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      if (user) {
        if (user.id) db.subscribeUserToListener(user.id, listenerId);
        if (user.id) db.setPermission(user.id, listenerId, {
          canCreate: true,
          canEdit: true,
          canAppend: true,
          canDelete: false,
          canList: true,
          canCreateDir: false,
          canRename: false
        });

        const perms = user.id ? db.getPermission(user.id, listenerId) : undefined;
        expect(perms).toBeDefined();
      }
    });

    test('should handle set-permissions', () => {
      db.createUser({ username: 'permuser', password: 'pass', passwordEnabled: true, guiEnabled: false });
      const user = db.getUser('permuser');

      const listenerId = db.createListener({
        name: 'Perm Test',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      if (user) {
        if (user.id) db.subscribeUserToListener(user.id, listenerId);
        if (user.id) db.setPermission(user.id, listenerId, {
          canCreate: true,
          canEdit: true,
          canAppend: true,
          canDelete: true,
          canList: true,
          canCreateDir: true,
          canRename: true
        });

        const perms = user.id ? db.getPermission(user.id, listenerId) : undefined;
        expect(perms?.canDelete).toBe(true);
      }
    });
  });

  describe('User-Listener Subscription IPC', () => {
    test('should handle subscribe-user-to-listener', () => {
      db.createUser({ username: 'subuser', password: 'pass', passwordEnabled: true, guiEnabled: false });
      const user = db.getUser('subuser');

      const listenerId = db.createListener({
        name: 'Sub Test',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      if (user) {
        if (user.id) db.subscribeUserToListener(user.id, listenerId);

        const listeners = user.id ? db.getUserListeners(user.id) : [];
        expect(listeners).toContain(listenerId);
      }
    });

    test('should handle unsubscribe-user-from-listener', () => {
      db.createUser({ username: 'unsubuser', password: 'pass', passwordEnabled: true, guiEnabled: false });
      const user = db.getUser('unsubuser');

      const listenerId = db.createListener({
        name: 'Unsub Test',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      if (user) {
        if (user.id) db.subscribeUserToListener(user.id, listenerId);
        if (user.id) db.unsubscribeUserFromListener(user.id, listenerId);

        const listeners = user.id ? db.getUserListeners(user.id) : [];
        expect(listeners).not.toContain(listenerId);
      }
    });

    test('should handle get-user-listeners', () => {
      db.createUser({ username: 'listeneruser', password: 'pass', passwordEnabled: true, guiEnabled: false });
      const user = db.getUser('listeneruser');

      const listener1 = db.createListener({
        name: 'Test 1',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      const listener2 = db.createListener({
        name: 'Test 2',
        protocol: 'FTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      if (user) {
        db.subscribeUserToListener(user.id, listener1);
        db.subscribeUserToListener(user.id, listener2);

        const listeners = user.id ? db.getUserListeners(user.id) : [];
        expect(listeners).toHaveLength(2);
      }
    });

    test('should handle get-listener-users', () => {
      db.createUser({ username: 'user1', password: 'pass1', passwordEnabled: true, guiEnabled: false });
      db.createUser({ username: 'user2', password: 'pass2', passwordEnabled: true, guiEnabled: false });
      const user1 = db.getUser('user1');
      const user2 = db.getUser('user2');

      const listenerId = db.createListener({
        name: 'Users Test',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      if (user1 && user2) {
        if (user1.id) db.subscribeUserToListener(user1.id, listenerId);
        if (user2.id) db.subscribeUserToListener(user2.id, listenerId);

        const users = db.getListenerUsers(listenerId!);
        expect(users).toHaveLength(2);
      }
    });
  });

  describe('Activity Logging IPC', () => {
    test('should handle get-recent-activities', () => {
      const listenerId = db.createListener({
        name: 'Activity Test',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      db.logActivity({
        listenerId: listenerId,
        username: 'testuser',
        action: 'FILE_UPLOAD',
        path: '/test.txt',
        success: true
      });

      const activities = db.getRecentActivities(listenerId);
      expect(activities.length).toBeGreaterThan(0);
    });

    test('should handle get-activities-with-limit', () => {
      const listenerId = db.createListener({
        name: 'Activity Test',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      // Log multiple activities
      for (let i = 0; i < 20; i++) {
        db.logActivity({
          listenerId: listenerId,
          username: 'testuser',
          action: 'FILE_UPLOAD',
          path: `/test${i}.txt`,
          success: true
        });
      }

      const activities = db.getRecentActivities(listenerId, 10);
      expect(activities).toHaveLength(10);
    });

    test('should handle get-all-activities', () => {
      const listener1 = db.createListener({
        name: 'Test 1',
        protocol: 'SFTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      const listener2 = db.createListener({
        name: 'Test 2',
        protocol: 'FTP',
        bindingIp: '127.0.0.1',
        port: 0,
        enabled: true
      });

      db.logActivity({
        listenerId: listener1,
        username: 'user1',
        action: 'FILE_UPLOAD',
        path: '/test1.txt',
        success: true
      });

      db.logActivity({
        listenerId: listener2,
        username: 'user2',
        action: 'FILE_DOWNLOAD',
        path: '/test2.txt',
        success: true
      });

      const activities = db.getRecentActivities();
      expect(activities.length).toBeGreaterThanOrEqual(2);
    });
  });

  describe('Session Management IPC', () => {
    test('should handle get-active-sessions', () => {
      const sessions = serverManager.getActiveSessions();
      expect(Array.isArray(sessions)).toBe(true);
    });

    test('should handle disconnect-session', () => {
      const result = serverManager.disconnectSession('fake-session');
      expect(typeof result).toBe('boolean');
      expect(result).toBe(false);
    });
  });

  describe('Authentication IPC', () => {
    test('should handle verify-password', () => {
      db.createUser({ username: 'authuser', password: 'authpass', passwordEnabled: true, guiEnabled: false });

      expect(db.verifyPassword('authuser', 'authpass')).toBe(true);
      expect(db.verifyPassword('authuser', 'wrongpass')).toBe(false);
    });

    test('should handle authenticate-gui-user', () => {
      db.createUser({ username: 'guiuser', password: 'guipass', passwordEnabled: true, guiEnabled: true });

      const user = db.getUser('guiuser');
      expect(user?.guiEnabled).toBe(true);
      expect(db.verifyPassword('guiuser', 'guipass')).toBe(true);
    });

    test('should reject non-GUI user', () => {
      db.createUser({ username: 'nonguiuser', password: 'pass', passwordEnabled: true, guiEnabled: false });

      const user = db.getUser('nonguiuser');
      expect(user?.guiEnabled).toBe(false);
    });
  });
});
